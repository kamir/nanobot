<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Group Management - GoMikroBot</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0' y1='0' x2='1' y2='1'%3E%3Cstop offset='0%25' stop-color='%23f59e0b'/%3E%3Cstop offset='100%25' stop-color='%23d97706'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect x='4' y='14' width='56' height='40' rx='10' fill='url(%23g)'/%3E%3Crect x='12' y='6' width='6' height='12' rx='3' fill='%23f59e0b'/%3E%3Crect x='46' y='6' width='6' height='12' rx='3' fill='%23d97706'/%3E%3Ccircle cx='22' cy='30' r='6' fill='%230d1117'/%3E%3Ccircle cx='22' cy='30' r='3' fill='%23f59e0b'/%3E%3Ccircle cx='42' cy='30' r='6' fill='%230d1117'/%3E%3Ccircle cx='42' cy='30' r='3' fill='%23d97706'/%3E%3Crect x='20' y='40' width='24' height='4' rx='2' fill='%230d1117'/%3E%3C/svg%3E">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&display=swap');

        body {
            font-family: 'JetBrains Mono', monospace;
            background-color: #0d1117;
            color: #c9d1d9;
        }

        .glass {
            background: rgba(22, 27, 34, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(48, 54, 61, 0.5);
        }

        .glass-card {
            background: rgba(22, 27, 34, 0.6);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(48, 54, 61, 0.4);
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .glass-card:hover {
            border-color: rgba(245, 158, 11, 0.4);
            box-shadow: 0 0 20px rgba(245, 158, 11, 0.05);
        }

        .self-card {
            border-color: rgba(245, 158, 11, 0.5) !important;
            box-shadow: 0 0 24px rgba(245, 158, 11, 0.08), inset 0 0 30px rgba(245, 158, 11, 0.03);
        }

        .tab-active {
            color: #f59e0b;
            border-bottom: 2px solid #f59e0b;
        }

        .tab-inactive {
            color: #6b7280;
            border-bottom: 2px solid transparent;
        }

        .tab-inactive:hover {
            color: #9ca3af;
            border-bottom-color: rgba(245, 158, 11, 0.3);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .status-active { background: #22c55e; box-shadow: 0 0 8px rgba(34, 197, 94, 0.5); }
        .status-stale { background: #eab308; box-shadow: 0 0 8px rgba(234, 179, 8, 0.3); }
        .status-inactive { background: #6b7280; }

        .badge {
            font-size: 10px;
            padding: 1px 8px;
            border-radius: 9999px;
            font-weight: 600;
            letter-spacing: 0.05em;
            text-transform: uppercase;
        }

        .badge-active { background: rgba(34, 197, 94, 0.15); color: #4ade80; border: 1px solid rgba(34, 197, 94, 0.3); }
        .badge-stale { background: rgba(234, 179, 8, 0.15); color: #facc15; border: 1px solid rgba(234, 179, 8, 0.3); }
        .badge-pending { background: rgba(59, 130, 246, 0.15); color: #60a5fa; border: 1px solid rgba(59, 130, 246, 0.3); }
        .badge-completed { background: rgba(34, 197, 94, 0.15); color: #4ade80; border: 1px solid rgba(34, 197, 94, 0.3); }
        .badge-failed { background: rgba(239, 68, 68, 0.15); color: #f87171; border: 1px solid rgba(239, 68, 68, 0.3); }
        .badge-rejected { background: rgba(168, 85, 247, 0.15); color: #c084fc; border: 1px solid rgba(168, 85, 247, 0.3); }
        .badge-outgoing { background: rgba(245, 158, 11, 0.15); color: #fbbf24; border: 1px solid rgba(245, 158, 11, 0.3); }
        .badge-incoming { background: rgba(59, 130, 246, 0.15); color: #60a5fa; border: 1px solid rgba(59, 130, 246, 0.3); }
        .badge-delegation { background: rgba(59, 130, 246, 0.15); color: #60a5fa; border: 1px solid rgba(59, 130, 246, 0.3); }
        .badge-policy { background: rgba(168, 85, 247, 0.15); color: #c084fc; border: 1px solid rgba(168, 85, 247, 0.3); }
        .badge-approval { background: rgba(245, 158, 11, 0.15); color: #fbbf24; border: 1px solid rgba(245, 158, 11, 0.3); }
        .badge-allowed { background: rgba(34, 197, 94, 0.15); color: #4ade80; border: 1px solid rgba(34, 197, 94, 0.3); }
        .badge-denied { background: rgba(239, 68, 68, 0.15); color: #f87171; border: 1px solid rgba(239, 68, 68, 0.3); }
        .badge-left { background: rgba(107, 114, 128, 0.15); color: #9ca3af; border: 1px solid rgba(107, 114, 128, 0.3); }
        .badge-joined { background: rgba(34, 197, 94, 0.15); color: #4ade80; border: 1px solid rgba(34, 197, 94, 0.3); }

        .pill {
            font-size: 9px;
            padding: 1px 6px;
            border-radius: 4px;
            background: rgba(245, 158, 11, 0.1);
            color: #fbbf24;
            border: 1px solid rgba(245, 158, 11, 0.2);
        }

        .span-INBOUND { color: #58a6ff; }
        .span-LLM { color: #a855f7; }
        .span-TOOL { color: #fb923c; }
        .span-OUTBOUND { color: #22c55e; }
        .span-POLICY { color: #ef4444; }
        .span-EVENT { color: #6366f1; }

        .input-field {
            background: rgba(13, 17, 23, 0.8);
            border: 1px solid #30363d;
            color: #c9d1d9;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            padding: 6px 10px;
            border-radius: 6px;
            outline: none;
            transition: border-color 0.2s;
        }

        .input-field:focus {
            border-color: #f59e0b;
        }

        .btn-primary {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: #0d1117;
            font-weight: 600;
            font-size: 11px;
            padding: 6px 16px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            transition: opacity 0.2s, transform 0.1s;
            letter-spacing: 0.05em;
        }

        .btn-primary:hover { opacity: 0.9; }
        .btn-primary:active { transform: scale(0.98); }
        .btn-primary:disabled { opacity: 0.4; cursor: not-allowed; }

        .btn-danger {
            background: rgba(239, 68, 68, 0.15);
            color: #f87171;
            border: 1px solid rgba(239, 68, 68, 0.3);
            font-weight: 600;
            font-size: 11px;
            padding: 6px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-danger:hover { background: rgba(239, 68, 68, 0.25); }

        .btn-ghost {
            background: transparent;
            color: #9ca3af;
            border: 1px solid #30363d;
            font-size: 11px;
            padding: 5px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-ghost:hover { color: #f59e0b; border-color: rgba(245, 158, 11, 0.4); }
        .btn-ghost.active { color: #f59e0b; border-color: #f59e0b; background: rgba(245, 158, 11, 0.08); }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #30363d; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #f59e0b; }

        [v-cloak] { display: none !important; }

        .fade-enter-active, .fade-leave-active { transition: opacity 0.15s; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }

        @keyframes pulse-ring {
            0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4); }
            70% { box-shadow: 0 0 0 6px rgba(34, 197, 94, 0); }
            100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
        }
        .pulse-ring { animation: pulse-ring 2s infinite; }

        .badge-control { background: rgba(88,166,255,0.15); color: #58a6ff; border: 1px solid rgba(88,166,255,0.3); }
        .badge-tasks { background: rgba(251,191,36,0.15); color: #fbbf24; border: 1px solid rgba(251,191,36,0.3); }
        .badge-observe { background: rgba(168,85,247,0.15); color: #a855f7; border: 1px solid rgba(168,85,247,0.3); }
        .badge-memory { background: rgba(34,197,94,0.15); color: #22c55e; border: 1px solid rgba(34,197,94,0.3); }
        .badge-skill { background: rgba(244,114,182,0.15); color: #f472b6; border: 1px solid rgba(244,114,182,0.3); }

        .rank-bronze { color: #cd7f32; }
        .rank-silver { color: #c0c0c0; }
        .rank-gold { color: #ffd700; }
        .rank-diamond { color: #b9f2ff; text-shadow: 0 0 10px rgba(185,242,255,0.5); }

        .xp-bar { height: 6px; border-radius: 3px; background: rgba(48,54,61,0.6); }
        .xp-fill { height: 100%; border-radius: 3px; transition: width 0.5s ease; }

        .topic-pulse { animation: topic-pulse-anim 2s ease-in-out infinite; }
        @keyframes topic-pulse-anim { 0%,100% { opacity: 0.6; } 50% { opacity: 1; } }

        .health-bar { height: 4px; border-radius: 2px; background: rgba(48,54,61,0.6); overflow: hidden; }
        .health-fill { height: 100%; border-radius: 2px; transition: width 0.5s ease; }

        .pipe-body { cursor: pointer; transition: opacity 0.2s, filter 0.2s; }
        .pipe-body:hover { filter: brightness(1.3); }
        .pipe-label { font-size: 9px; fill: #9ca3af; }
        .pipe-count { font-size: 9px; fill: #6b7280; text-anchor: end; }
        .agent-label { font-size: 9px; fill: #c9d1d9; text-anchor: middle; }
        .factory-ground { fill: #161b22; }
        .factory-sky { fill: #0a0e14; }
        .support-stilt { stroke: #30363d; stroke-width: 3; }
        .level-label { font-size: 11px; fill: #6b7280; text-transform: uppercase; letter-spacing: 0.1em; }
        .density-popup { position: fixed; z-index: 60; pointer-events: auto; }
        .density-popup .sparkline-area { opacity: 0.25; }
        .density-popup .sparkline-line { fill: none; stroke-width: 1.5; }
        .density-popup .env-tag { display: inline-block; padding: 1px 6px; border-radius: 4px; background: rgba(48,54,61,0.5); color: #9ca3af; border: 1px solid rgba(48,54,61,0.6); margin: 2px; }
    </style>
</head>

<body class="h-screen flex flex-col overflow-hidden">
    <div id="app" v-cloak class="flex flex-col h-full">

        <!-- Header -->
        <header class="glass z-10 shadow-lg border-b border-gray-800/50">
            <div class="px-6 py-3 flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <a href="/timeline" class="flex items-center gap-2 text-gray-400 hover:text-amber-400 transition-colors text-xs">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/>
                        </svg>
                        Timeline
                    </a>
                    <div class="w-px h-5 bg-gray-700"></div>
                    <div class="flex items-center gap-3">
                        <div class="status-dot" :class="groupActive ? 'status-active pulse-ring' : 'status-inactive'"></div>
                        <h1 class="text-lg font-bold text-white tracking-widest">GROUP <span class="text-amber-400">MGMT</span></h1>
                    </div>
                    <span v-if="status.group_name" class="text-xs text-gray-500 ml-1">{{ status.group_name }}</span>
                </div>
                <div class="flex items-center gap-3">
                    <span class="text-[10px] text-gray-500 tracking-wider">{{ status.agent_id || 'no agent' }}</span>
                    <button v-if="!groupActive" @click="showJoinModal = true" class="btn-primary">JOIN GROUP</button>
                    <button v-else @click="leaveGroup" :disabled="leaving" class="btn-danger text-xs">
                        {{ leaving ? 'LEAVING...' : 'LEAVE GROUP' }}
                    </button>
                </div>
            </div>

            <!-- Tabs -->
            <div class="px-6 flex gap-0 border-t border-gray-800/30">
                <button v-for="tab in tabs" :key="tab.id"
                    @click="activeTab = tab.id"
                    class="px-4 py-2.5 text-xs font-semibold tracking-wider transition-all"
                    :class="activeTab === tab.id ? 'tab-active' : 'tab-inactive'">
                    {{ tab.label }}
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto p-6">

            <!-- Overview Tab -->
            <div v-if="activeTab === 'overview'" class="max-w-5xl mx-auto space-y-6">
                <!-- Status Cards -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="glass-card rounded-lg p-4">
                        <div class="text-[10px] text-gray-500 uppercase tracking-wider mb-1">Group</div>
                        <div class="text-lg font-bold text-white">{{ status.group_name || '---' }}</div>
                    </div>
                    <div class="glass-card rounded-lg p-4">
                        <div class="text-[10px] text-gray-500 uppercase tracking-wider mb-1">Status</div>
                        <div class="flex items-center gap-2">
                            <div class="status-dot" :class="groupActive ? 'status-active' : 'status-inactive'"></div>
                            <span class="text-lg font-bold" :class="groupActive ? 'text-green-400' : 'text-gray-500'">
                                {{ groupActive ? 'Active' : 'Inactive' }}
                            </span>
                        </div>
                    </div>
                    <div class="glass-card rounded-lg p-4">
                        <div class="text-[10px] text-gray-500 uppercase tracking-wider mb-1">Members</div>
                        <div class="text-lg font-bold text-amber-400">{{ status.member_count || 0 }}</div>
                    </div>
                    <div class="glass-card rounded-lg p-4">
                        <div class="text-[10px] text-gray-500 uppercase tracking-wider mb-1">Agent ID</div>
                        <div class="text-sm font-medium text-gray-300 truncate">{{ status.agent_id || '---' }}</div>
                    </div>
                </div>

                <!-- Stats Cards -->
                <div v-if="stats" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="glass-card rounded-lg p-4">
                        <div class="text-[10px] text-gray-500 uppercase tracking-wider mb-1">Tasks (24h)</div>
                        <div class="text-lg font-bold text-amber-400">{{ stats.tasks_last_24h || 0 }}</div>
                    </div>
                    <div class="glass-card rounded-lg p-4">
                        <div class="text-[10px] text-gray-500 uppercase tracking-wider mb-1">Tasks (7d)</div>
                        <div class="text-lg font-bold text-blue-400">{{ stats.tasks_last_7d || 0 }}</div>
                    </div>
                    <div class="glass-card rounded-lg p-4">
                        <div class="text-[10px] text-gray-500 uppercase tracking-wider mb-1">Avg Response</div>
                        <div class="text-lg font-bold text-green-400">{{ formatDuration(stats.avg_response_secs) }}</div>
                    </div>
                    <div class="glass-card rounded-lg p-4">
                        <div class="text-[10px] text-gray-500 uppercase tracking-wider mb-1">Max Delegation</div>
                        <div class="text-lg font-bold text-purple-400">{{ stats.max_delegation_depth || 0 }}</div>
                    </div>
                </div>

                <!-- Previous Groups (when not active) -->
                <div v-if="!groupActive && previousMembers.length > 0" class="glass-card rounded-lg p-4">
                    <div class="text-xs text-gray-400 uppercase tracking-wider font-semibold mb-3">Previous Groups</div>
                    <div class="space-y-2">
                        <div v-for="pm in previousMembers" :key="pm.agent_id" class="flex items-center justify-between bg-[#0d1117] rounded-lg p-3">
                            <div>
                                <div class="text-sm text-gray-300 font-medium">{{ pm.agent_name || pm.agent_id }}</div>
                                <div class="text-[10px] text-gray-600">Left {{ relativeTime(pm.left_at) }}</div>
                            </div>
                            <button @click="rejoinGroup(pm.agent_id)" class="btn-primary text-[10px]">REJOIN</button>
                        </div>
                    </div>
                </div>

                <!-- Health Indicators -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="glass-card rounded-lg p-4">
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-xs text-gray-400 uppercase tracking-wider font-semibold">LFS Proxy</span>
                            <div class="flex items-center gap-2">
                                <div class="status-dot" :class="status.lfs_healthy ? 'status-active' : 'status-inactive'"></div>
                                <span class="text-xs" :class="status.lfs_healthy ? 'text-green-400' : 'text-red-400'">
                                    {{ status.lfs_healthy ? 'Reachable' : 'Down' }}
                                </span>
                            </div>
                        </div>
                        <div class="text-[11px] text-gray-500 truncate">{{ status.lfs_proxy_url || 'not configured' }}</div>
                    </div>
                    <div class="glass-card rounded-lg p-4">
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-xs text-gray-400 uppercase tracking-wider font-semibold">Kafka</span>
                            <div class="flex items-center gap-2">
                                <div class="status-dot" :class="groupActive ? 'status-active' : 'status-inactive'"></div>
                                <span class="text-xs" :class="groupActive ? 'text-green-400' : 'text-gray-500'">
                                    {{ groupActive ? 'Connected' : 'Disconnected' }}
                                </span>
                            </div>
                        </div>
                        <div class="text-[11px] text-gray-500">{{ config.kafka_brokers || 'not configured' }}</div>
                    </div>
                </div>

                <!-- Quick Join -->
                <div v-if="!groupActive" class="glass-card rounded-lg p-6">
                    <div class="text-xs text-gray-400 uppercase tracking-wider font-semibold mb-4">Quick Join</div>
                    <div class="flex gap-3">
                        <input v-model="quickJoinName" class="input-field flex-1" placeholder="Group name..." @keyup.enter="quickJoin">
                        <button @click="quickJoin" :disabled="!quickJoinName.trim() || joining" class="btn-primary">
                            {{ joining ? 'JOINING...' : 'JOIN' }}
                        </button>
                    </div>
                </div>

                <!-- Decentralized Notice -->
                <div class="glass-card rounded-lg p-4 border-amber-900/30">
                    <div class="flex items-start gap-3">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-amber-500 shrink-0 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <div>
                            <div class="text-xs text-amber-400 font-semibold mb-1">Decentralized View</div>
                            <div class="text-[11px] text-gray-500 leading-relaxed">
                                This is your agent's local view of the group. Each agent maintains its own roster
                                based on Kafka announcements and heartbeats. Member status is eventually consistent.
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Members Tab -->
            <div v-if="activeTab === 'members'" class="max-w-5xl mx-auto">
                <div v-if="members.length === 0" class="text-center py-20">
                    <div class="text-gray-600 text-sm">No members in group</div>
                    <div class="text-gray-700 text-xs mt-2">Join a group to see members</div>
                </div>
                <div v-else class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div v-for="member in members" :key="member.agent_id"
                        class="glass-card rounded-lg p-4"
                        :class="{ 'self-card': member.agent_id === status.agent_id }">
                        <!-- Header -->
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center gap-2">
                                    <span class="text-sm font-bold text-white truncate">{{ member.agent_name || member.agent_id }}</span>
                                    <span v-if="member.role" class="text-[9px] px-1.5 py-0.5 rounded bg-purple-900/30 text-purple-400 border border-purple-800/40 uppercase tracking-wider">{{ member.role }}</span>
                                    <span v-if="member.agent_id === status.agent_id" class="text-[9px] px-1.5 py-0.5 rounded bg-amber-900/30 text-amber-400 border border-amber-800/40">YOU</span>
                                </div>
                                <div class="text-[10px] text-gray-600 mt-0.5 truncate">{{ member.agent_id }}</div>
                            </div>
                            <span class="badge" :class="member.status === 'active' ? 'badge-active' : 'badge-stale'">
                                {{ member.status }}
                            </span>
                        </div>

                        <!-- Model -->
                        <div class="text-[10px] text-gray-500 mb-2">
                            Model: <span class="text-gray-300">{{ member.model || '---' }}</span>
                        </div>

                        <!-- Capabilities -->
                        <div v-if="parseCaps(member.capabilities).length" class="flex flex-wrap gap-1 mb-2">
                            <span v-for="cap in parseCaps(member.capabilities).slice(0, 6)" :key="cap" class="pill">{{ cap }}</span>
                            <span v-if="parseCaps(member.capabilities).length > 6" class="pill">+{{ parseCaps(member.capabilities).length - 6 }}</span>
                        </div>

                        <!-- Channels -->
                        <div v-if="parseChannels(member.channels).length" class="text-[10px] text-gray-500 mb-2">
                            Channels: <span class="text-gray-400">{{ parseChannels(member.channels).join(', ') }}</span>
                        </div>

                        <!-- Soul Summary -->
                        <div v-if="member.soul_summary" class="text-[10px] text-gray-500 mt-2 line-clamp-2 leading-relaxed">
                            {{ member.soul_summary }}
                        </div>

                        <!-- Last Seen -->
                        <div class="text-[9px] text-gray-600 mt-3 flex items-center gap-1">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            {{ relativeTime(member.last_seen) }}
                        </div>
                    </div>
                </div>

                <!-- Membership History -->
                <div v-if="membershipHistory.length > 0" class="mt-6">
                    <div class="text-xs text-gray-400 uppercase tracking-wider font-semibold mb-3">Membership History</div>
                    <div class="space-y-1">
                        <div v-for="entry in membershipHistory" :key="entry.id" class="glass-card rounded-lg px-4 py-2.5 flex items-center gap-3">
                            <span class="badge" :class="entry.action === 'joined' ? 'badge-joined' : 'badge-left'">
                                {{ entry.action }}
                            </span>
                            <span class="text-xs text-gray-300">{{ entry.agent_name || entry.agent_id }}</span>
                            <span class="text-[10px] text-gray-600 ml-auto">{{ formatTime(entry.happened_at) }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tasks Tab -->
            <div v-if="activeTab === 'tasks'" class="max-w-5xl mx-auto space-y-4">
                <!-- Submit Task -->
                <div v-if="groupActive" class="glass-card rounded-lg p-4">
                    <div class="text-xs text-gray-400 uppercase tracking-wider font-semibold mb-3">Submit Task to Group</div>
                    <div class="space-y-2">
                        <input v-model="taskDescription" class="input-field w-full" placeholder="Task description...">
                        <textarea v-model="taskContent" class="input-field w-full" rows="3" placeholder="Task content (optional)..."></textarea>
                        <div class="flex justify-end">
                            <button @click="submitTask" :disabled="!taskDescription.trim() || submittingTask" class="btn-primary">
                                {{ submittingTask ? 'SUBMITTING...' : 'SUBMIT TASK' }}
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Filters -->
                <div class="flex items-center gap-2">
                    <button @click="taskFilter = ''" class="btn-ghost text-[10px]" :class="{ active: taskFilter === '' }">All</button>
                    <button @click="taskFilter = 'outgoing'" class="btn-ghost text-[10px]" :class="{ active: taskFilter === 'outgoing' }">Outgoing</button>
                    <button @click="taskFilter = 'incoming'" class="btn-ghost text-[10px]" :class="{ active: taskFilter === 'incoming' }">Incoming</button>
                    <div class="w-px h-4 bg-gray-700 mx-1"></div>
                    <button @click="taskStatusFilter = ''" class="btn-ghost text-[10px]" :class="{ active: taskStatusFilter === '' }">All Status</button>
                    <button @click="taskStatusFilter = 'pending'" class="btn-ghost text-[10px]" :class="{ active: taskStatusFilter === 'pending' }">Pending</button>
                    <button @click="taskStatusFilter = 'completed'" class="btn-ghost text-[10px]" :class="{ active: taskStatusFilter === 'completed' }">Completed</button>
                    <button @click="taskStatusFilter = 'failed'" class="btn-ghost text-[10px]" :class="{ active: taskStatusFilter === 'failed' }">Failed</button>
                </div>

                <!-- Task List -->
                <div v-if="tasks.length === 0" class="text-center py-16">
                    <div class="text-gray-600 text-sm">No tasks found</div>
                </div>
                <div v-else class="space-y-2">
                    <div v-for="task in tasks" :key="task.id" class="glass-card rounded-lg p-4">
                        <div class="flex items-start justify-between mb-2">
                            <div class="flex items-center gap-2">
                                <span class="badge" :class="'badge-' + task.direction">
                                    {{ task.direction === 'outgoing' ? '&#x2191;' : '&#x2193;' }} {{ task.direction }}
                                </span>
                                <span class="badge" :class="'badge-' + task.status">{{ task.status }}</span>
                            </div>
                            <span class="text-[9px] text-gray-600">{{ formatTime(task.created_at) }}</span>
                        </div>
                        <div class="text-sm text-gray-200 mb-1">{{ task.description }}</div>
                        <div v-if="task.content" class="text-[11px] text-gray-500 mb-2 line-clamp-2">{{ task.content }}</div>
                        <div class="flex items-center gap-3 text-[9px] text-gray-600">
                            <span>From: <span class="text-gray-400">{{ task.requester_id }}</span></span>
                            <span v-if="task.responder_id">To: <span class="text-gray-400">{{ task.responder_id }}</span></span>
                        </div>
                        <!-- Expandable Response -->
                        <div v-if="task.response_content" class="mt-3 pt-3 border-t border-gray-800">
                            <button @click="toggleTaskExpand(task.id)" class="text-[10px] text-amber-400 hover:text-amber-300 mb-1">
                                {{ expandedTasks[task.id] ? 'Hide Response' : 'Show Response' }}
                            </button>
                            <div v-if="expandedTasks[task.id]" class="text-[11px] text-gray-400 mt-1 bg-[#0d1117] rounded p-3 max-h-40 overflow-y-auto">
                                {{ task.response_content }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Traces Tab -->
            <div v-if="activeTab === 'traces'" class="max-w-5xl mx-auto space-y-6">

                <!-- Local End-to-End Traces -->
                <div>
                    <div class="text-xs text-gray-400 uppercase tracking-wider font-semibold mb-3">End-to-End Traces</div>
                    <div v-if="localTasks.length === 0" class="text-center py-8">
                        <div class="text-gray-600 text-sm">No local traces yet</div>
                    </div>
                    <div v-else class="space-y-1">
                        <div class="grid grid-cols-12 gap-2 px-3 py-2 text-[9px] text-gray-600 uppercase tracking-wider font-semibold">
                            <div class="col-span-1">Status</div>
                            <div class="col-span-2">Channel</div>
                            <div class="col-span-3">Input</div>
                            <div class="col-span-2">Tokens</div>
                            <div class="col-span-1">Delivery</div>
                            <div class="col-span-2">Time</div>
                            <div class="col-span-1"></div>
                        </div>
                        <div v-for="lt in localTasks" :key="lt.task_id" class="glass-card rounded-lg">
                            <div class="grid grid-cols-12 gap-2 px-3 py-2.5 items-center text-xs cursor-pointer" @click="expandLocalTrace(lt.trace_id)">
                                <div class="col-span-1">
                                    <span class="badge" :class="'badge-' + lt.status">{{ lt.status }}</span>
                                </div>
                                <div class="col-span-2 text-gray-400 truncate text-[10px]">{{ lt.channel }}:{{ lt.chat_id }}</div>
                                <div class="col-span-3 text-gray-300 truncate text-[10px]">{{ lt.content_in }}</div>
                                <div class="col-span-2 text-gray-500 text-[10px]">
                                    <span v-if="lt.total_tokens">{{ lt.prompt_tokens }}+{{ lt.completion_tokens }}={{ lt.total_tokens }}</span>
                                    <span v-else>-</span>
                                </div>
                                <div class="col-span-1">
                                    <span class="text-[9px]" :class="lt.delivery_status === 'sent' ? 'text-green-400' : lt.delivery_status === 'failed' ? 'text-red-400' : 'text-gray-500'">{{ lt.delivery_status }}</span>
                                </div>
                                <div class="col-span-2 text-gray-600 text-[10px]">{{ formatTime(lt.created_at) }}</div>
                                <div class="col-span-1 text-right">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 text-gray-600 transition-transform inline" :class="{ 'rotate-180': expandedLocalTrace === lt.trace_id }" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/>
                                    </svg>
                                </div>
                            </div>
                            <!-- Expanded: end-to-end span breakdown -->
                            <div v-if="expandedLocalTrace === lt.trace_id" class="px-3 pb-3 space-y-2">
                                <div v-if="localTraceLoading" class="text-[10px] text-gray-500 py-2">Loading trace...</div>
                                <template v-else>
                                    <!-- Span pipeline -->
                                    <div v-if="localTraceSpans.length > 0" class="flex flex-wrap gap-1 items-center py-1">
                                        <template v-for="(span, si) in localTraceSpans" :key="si">
                                            <div class="flex items-center gap-1 px-2 py-1 rounded text-[10px] font-semibold cursor-pointer transition-all"
                                                :style="{ background: spanTypeColor(span.type) + (selectedLocalSpan === si ? '40' : '20'), color: spanTypeColor(span.type), border: '2px solid ' + spanTypeColor(span.type) + (selectedLocalSpan === si ? 'cc' : '40') }"
                                                @click="selectedLocalSpan = selectedLocalSpan === si ? null : si">
                                                {{ span.type }}
                                                <span class="text-[9px] opacity-60">{{ span.time }}</span>
                                                <span v-if="span.duration" class="text-[9px] opacity-40">{{ span.duration }}</span>
                                            </div>
                                            <svg v-if="si < localTraceSpans.length - 1" class="h-3 w-3 text-gray-600 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/>
                                            </svg>
                                        </template>
                                    </div>
                                    <div v-else class="text-[10px] text-gray-600 italic">No spans recorded for this trace</div>
                                    <!-- Span detail panel -->
                                    <div v-if="selectedLocalSpan !== null && localTraceSpans[selectedLocalSpan]" class="bg-[#0d1117] rounded p-3 text-[10px] text-gray-400 space-y-2 border border-gray-800">
                                        <template v-if="localTraceSpans[selectedLocalSpan].type === 'LLM' && localTraceSpans[selectedLocalSpan].metadata">
                                            <div class="grid grid-cols-4 gap-x-4 gap-y-1 text-gray-500">
                                                <span>Model: <span class="text-purple-400">{{ localTraceSpans[selectedLocalSpan].metadata.model }}</span></span>
                                                <span>Temp: <span class="text-gray-400">{{ localTraceSpans[selectedLocalSpan].metadata.temperature }}</span></span>
                                                <span>Max Tokens: <span class="text-gray-400">{{ localTraceSpans[selectedLocalSpan].metadata.max_tokens }}</span></span>
                                                <span>Duration: <span class="text-gray-400">{{ localTraceSpans[selectedLocalSpan].metadata.duration_ms }}ms</span></span>
                                                <span>Prompt Tokens: <span class="text-blue-400">{{ localTraceSpans[selectedLocalSpan].metadata.prompt_tokens }}</span></span>
                                                <span>Completion Tokens: <span class="text-green-400">{{ localTraceSpans[selectedLocalSpan].metadata.completion_tokens }}</span></span>
                                                <span>Total Tokens: <span class="text-yellow-400">{{ localTraceSpans[selectedLocalSpan].metadata.total_tokens }}</span></span>
                                                <span>Finish: <span class="text-gray-400">{{ localTraceSpans[selectedLocalSpan].metadata.finish_reason }}</span></span>
                                            </div>
                                            <div v-if="localTraceSpans[selectedLocalSpan].metadata.system_prompt" class="space-y-1">
                                                <div class="text-[9px] text-gray-600 uppercase font-semibold">System Prompt</div>
                                                <pre class="whitespace-pre-wrap max-h-32 overflow-y-auto bg-[#161b22] rounded p-2 text-gray-500 text-[10px]">{{ localTraceSpans[selectedLocalSpan].metadata.system_prompt }}</pre>
                                            </div>
                                            <div v-if="localTraceSpans[selectedLocalSpan].metadata.last_user_message" class="space-y-1">
                                                <div class="text-[9px] text-gray-600 uppercase font-semibold">Last User Message</div>
                                                <pre class="whitespace-pre-wrap max-h-32 overflow-y-auto bg-[#161b22] rounded p-2 text-blue-400/80 text-[10px]">{{ localTraceSpans[selectedLocalSpan].metadata.last_user_message }}</pre>
                                            </div>
                                            <div v-if="localTraceSpans[selectedLocalSpan].metadata.response_text" class="space-y-1">
                                                <div class="text-[9px] text-gray-600 uppercase font-semibold">LLM Response</div>
                                                <pre class="whitespace-pre-wrap max-h-32 overflow-y-auto bg-[#161b22] rounded p-2 text-green-400/80 text-[10px]">{{ localTraceSpans[selectedLocalSpan].metadata.response_text }}</pre>
                                            </div>
                                            <div v-if="localTraceSpans[selectedLocalSpan].metadata.tool_calls && localTraceSpans[selectedLocalSpan].metadata.tool_calls.length > 0" class="space-y-1">
                                                <div class="text-[9px] text-gray-600 uppercase font-semibold">Tool Calls Requested</div>
                                                <div v-for="(tc, tci) in localTraceSpans[selectedLocalSpan].metadata.tool_calls" :key="tci" class="bg-[#161b22] rounded p-2 space-y-1">
                                                    <span class="text-orange-400 font-semibold">{{ tc.name }}</span>
                                                    <pre class="whitespace-pre-wrap max-h-24 overflow-y-auto text-gray-500 text-[10px]">{{ JSON.stringify(tc.arguments, null, 2) }}</pre>
                                                </div>
                                            </div>
                                        </template>
                                        <template v-else-if="localTraceSpans[selectedLocalSpan].type === 'TOOL' && localTraceSpans[selectedLocalSpan].metadata">
                                            <div class="grid grid-cols-3 gap-x-4 gap-y-1 text-gray-500">
                                                <span>Tool: <span class="text-orange-400 font-semibold">{{ localTraceSpans[selectedLocalSpan].metadata.tool_name }}</span></span>
                                                <span>Duration: <span class="text-gray-400">{{ localTraceSpans[selectedLocalSpan].metadata.duration_ms }}ms</span></span>
                                                <span>Call ID: <span class="text-gray-600">{{ localTraceSpans[selectedLocalSpan].metadata.tool_call_id }}</span></span>
                                            </div>
                                            <div v-if="localTraceSpans[selectedLocalSpan].metadata.arguments" class="space-y-1">
                                                <div class="text-[9px] text-gray-600 uppercase font-semibold">Arguments</div>
                                                <pre class="whitespace-pre-wrap max-h-32 overflow-y-auto bg-[#161b22] rounded p-2 text-blue-400/80 text-[10px]">{{ JSON.stringify(localTraceSpans[selectedLocalSpan].metadata.arguments, null, 2) }}</pre>
                                            </div>
                                            <div v-if="localTraceSpans[selectedLocalSpan].metadata.result" class="space-y-1">
                                                <div class="text-[9px] text-gray-600 uppercase font-semibold">Result</div>
                                                <pre class="whitespace-pre-wrap max-h-32 overflow-y-auto bg-[#161b22] rounded p-2 text-green-400/80 text-[10px]">{{ localTraceSpans[selectedLocalSpan].metadata.result }}</pre>
                                            </div>
                                            <div v-if="localTraceSpans[selectedLocalSpan].metadata.error" class="space-y-1">
                                                <div class="text-[9px] text-gray-600 uppercase font-semibold">Error</div>
                                                <pre class="whitespace-pre-wrap bg-[#161b22] rounded p-2 text-red-400 text-[10px]">{{ localTraceSpans[selectedLocalSpan].metadata.error }}</pre>
                                            </div>
                                        </template>
                                        <template v-else-if="localTraceSpans[selectedLocalSpan].type === 'INBOUND' && localTraceSpans[selectedLocalSpan].metadata">
                                            <div class="grid grid-cols-3 gap-x-4 gap-y-1 text-gray-500">
                                                <span>Channel: <span class="text-blue-400">{{ localTraceSpans[selectedLocalSpan].metadata.channel }}</span></span>
                                                <span>Sender: <span class="text-gray-400">{{ localTraceSpans[selectedLocalSpan].metadata.sender }}</span></span>
                                                <span>Type: <span class="text-gray-400">{{ localTraceSpans[selectedLocalSpan].metadata.message_type }}</span></span>
                                            </div>
                                            <div v-if="localTraceSpans[selectedLocalSpan].metadata.content" class="space-y-1">
                                                <div class="text-[9px] text-gray-600 uppercase font-semibold">Message Content</div>
                                                <pre class="whitespace-pre-wrap max-h-32 overflow-y-auto bg-[#161b22] rounded p-2 text-blue-400/80 text-[10px]">{{ localTraceSpans[selectedLocalSpan].metadata.content }}</pre>
                                            </div>
                                        </template>
                                        <template v-else-if="localTraceSpans[selectedLocalSpan].type === 'OUTBOUND'">
                                            <div v-if="localTraceSpans[selectedLocalSpan].metadata" class="grid grid-cols-2 gap-x-4 gap-y-1 text-gray-500">
                                                <span>Delivery: <span class="text-green-400">{{ localTraceSpans[selectedLocalSpan].metadata.delivery_status }}</span></span>
                                            </div>
                                            <div v-if="localTraceSpans[selectedLocalSpan].metadata && localTraceSpans[selectedLocalSpan].metadata.response_text" class="space-y-1">
                                                <div class="text-[9px] text-gray-600 uppercase font-semibold">Response Text</div>
                                                <pre class="whitespace-pre-wrap max-h-32 overflow-y-auto bg-[#161b22] rounded p-2 text-green-400/80 text-[10px]">{{ localTraceSpans[selectedLocalSpan].metadata.response_text }}</pre>
                                            </div>
                                        </template>
                                        <div v-else class="text-gray-600 italic">No detailed metadata available for this span</div>
                                    </div>
                                    <!-- Task metadata -->
                                    <div v-if="localTraceTask" class="bg-[#0d1117] rounded p-2 text-[10px] text-gray-500 grid grid-cols-3 gap-x-4 gap-y-1">
                                        <span>Task: <span class="text-gray-400">{{ localTraceTask.task_id }}</span></span>
                                        <span>Status: <span class="text-gray-400">{{ localTraceTask.status }}</span></span>
                                        <span>Delivery: <span class="text-gray-400">{{ localTraceTask.delivery_status }}</span></span>
                                        <span>Prompt: <span class="text-gray-400">{{ localTraceTask.prompt_tokens }}</span></span>
                                        <span>Completion: <span class="text-gray-400">{{ localTraceTask.completion_tokens }}</span></span>
                                        <span>Total: <span class="text-gray-400">{{ localTraceTask.total_tokens }}</span></span>
                                    </div>
                                    <!-- Policy decisions -->
                                    <div v-if="localTracePolicy.length > 0" class="flex flex-wrap gap-1">
                                        <div v-for="(pd, pi) in localTracePolicy" :key="pi"
                                            class="text-[9px] px-2 py-0.5 rounded"
                                            :class="pd.allowed ? 'bg-green-900/20 text-green-400 border border-green-800/30' : 'bg-red-900/20 text-red-400 border border-red-800/30'">
                                            {{ pd.tool }} T{{ pd.tier }} {{ pd.allowed ? 'ALLOW' : 'DENY' }}
                                        </div>
                                    </div>
                                    <!-- Input/Output preview -->
                                    <div v-if="lt.content_in || lt.content_out" class="bg-[#0d1117] rounded p-2 space-y-1 max-h-48 overflow-y-auto">
                                        <div v-if="lt.content_in" class="text-[10px]">
                                            <span class="text-blue-400 font-semibold">IN:</span>
                                            <span class="text-gray-400 ml-1">{{ lt.content_in }}</span>
                                        </div>
                                        <div v-if="lt.content_out" class="text-[10px]">
                                            <span class="text-green-400 font-semibold">OUT:</span>
                                            <span class="text-gray-400 ml-1 whitespace-pre-wrap">{{ lt.content_out }}</span>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Group Traces (inter-agent) -->
                <div>
                    <div class="flex items-center gap-3 mb-3">
                        <div class="text-xs text-gray-400 uppercase tracking-wider font-semibold">Group Traces</div>
                        <select v-model="traceAgentFilter" class="input-field text-xs" @change="loadTraces">
                            <option value="">All agents</option>
                            <option v-for="agent in traceAgents" :key="agent" :value="agent">{{ agent }}</option>
                        </select>
                    </div>

                    <div v-if="traces.length === 0" class="text-center py-8">
                        <div class="text-gray-600 text-sm">No group traces found</div>
                    </div>
                    <div v-else class="space-y-1">
                        <div class="grid grid-cols-12 gap-2 px-3 py-2 text-[9px] text-gray-600 uppercase tracking-wider font-semibold">
                            <div class="col-span-2">Source</div>
                            <div class="col-span-2">Trace ID</div>
                            <div class="col-span-1">Type</div>
                            <div class="col-span-3">Title</div>
                            <div class="col-span-1">Duration</div>
                            <div class="col-span-2">Time</div>
                            <div class="col-span-1"></div>
                        </div>
                        <div v-for="trace in traces" :key="trace.id" class="glass-card rounded-lg">
                            <div class="grid grid-cols-12 gap-2 px-3 py-2.5 items-center text-xs cursor-pointer" @click="toggleTraceExpand(trace.id)">
                                <div class="col-span-2 text-gray-300 truncate">{{ trace.source_agent_id }}</div>
                                <div class="col-span-2 text-gray-500 truncate font-mono text-[10px]">{{ trace.trace_id }}</div>
                                <div class="col-span-1">
                                    <span class="text-[10px] font-semibold" :class="'span-' + (trace.span_type || 'EVENT')">{{ trace.span_type || 'EVENT' }}</span>
                                </div>
                                <div class="col-span-3 text-gray-300 truncate">{{ trace.title }}</div>
                                <div class="col-span-1 text-gray-500 text-[10px]">{{ trace.duration_ms ? trace.duration_ms + 'ms' : '-' }}</div>
                                <div class="col-span-2 text-gray-600 text-[10px]">{{ formatTime(trace.created_at) }}</div>
                                <div class="col-span-1 text-right">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 text-gray-600 transition-transform inline" :class="{ 'rotate-180': expandedTraces[trace.id] }" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/>
                                    </svg>
                                </div>
                            </div>
                            <div v-if="expandedTraces[trace.id] && trace.content" class="px-3 pb-3">
                                <div class="text-[11px] text-gray-500 bg-[#0d1117] rounded p-3 max-h-48 overflow-y-auto whitespace-pre-wrap">{{ trace.content }}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Audit Tab -->
            <div v-if="activeTab === 'audit'" class="max-w-5xl mx-auto space-y-4">
                <!-- Filters -->
                <div class="flex items-center gap-2 flex-wrap">
                    <button @click="auditSourceFilter = ''" class="btn-ghost text-[10px]" :class="{ active: auditSourceFilter === '' }">All</button>
                    <button @click="auditSourceFilter = 'delegation'" class="btn-ghost text-[10px]" :class="{ active: auditSourceFilter === 'delegation' }">Delegation</button>
                    <button @click="auditSourceFilter = 'policy'" class="btn-ghost text-[10px]" :class="{ active: auditSourceFilter === 'policy' }">Policy</button>
                    <button @click="auditSourceFilter = 'approval'" class="btn-ghost text-[10px]" :class="{ active: auditSourceFilter === 'approval' }">Approval</button>
                    <div class="w-px h-4 bg-gray-700 mx-1"></div>
                    <input v-model="auditAgentFilter" class="input-field text-[10px]" placeholder="Agent ID..." style="width: 180px;">
                </div>

                <!-- Audit Log -->
                <div v-if="filteredAuditEntries.length === 0" class="text-center py-16">
                    <div class="text-gray-600 text-sm">No audit entries found</div>
                </div>
                <div v-else class="space-y-1">
                    <div v-for="entry in filteredAuditEntries" :key="entry.source + '-' + entry.id" class="glass-card rounded-lg px-4 py-3">
                        <div class="flex items-center gap-2 flex-wrap">
                            <span class="badge" :class="'badge-' + entry.source">{{ entry.source }}</span>
                            <span class="badge" :class="entry.event_type === 'denied' ? 'badge-denied' : entry.event_type === 'allowed' ? 'badge-allowed' : 'badge-' + entry.event_type">{{ entry.event_type }}</span>
                            <span v-if="entry.tier > 0" class="text-[9px] text-gray-500">Tier {{ entry.tier }}</span>
                            <span v-if="entry.agent_id" class="text-[10px] text-gray-400">{{ entry.agent_id }}</span>
                            <span v-if="entry.target_id" class="text-[10px] text-gray-600">&rarr; {{ entry.target_id }}</span>
                            <span class="text-[9px] text-gray-600 ml-auto">{{ formatTime(entry.created_at) }}</span>
                        </div>
                        <div v-if="entry.details" class="text-[10px] text-gray-500 mt-1 truncate">{{ entry.details }}</div>
                    </div>
                </div>
            </div>

            <!-- Topics Tab -->
            <div v-if="activeTab === 'topics'" class="space-y-6">

                <!-- Section A: Chemical Factory Pipe Visualization -->
                <div class="max-w-7xl mx-auto">
                    <div class="flex items-center justify-between mb-3">
                        <div class="text-xs text-gray-400 uppercase tracking-wider font-semibold">Topic Factory</div>
                        <div class="flex items-center gap-4 text-[10px] text-gray-500">
                            <span><span class="inline-block w-2 h-2 rounded-full mr-1" style="background:#58a6ff"></span>Control</span>
                            <span><span class="inline-block w-2 h-2 rounded-full mr-1" style="background:#fbbf24"></span>Tasks</span>
                            <span><span class="inline-block w-2 h-2 rounded-full mr-1" style="background:#a855f7"></span>Observe</span>
                            <span><span class="inline-block w-2 h-2 rounded-full mr-1" style="background:#22c55e"></span>Memory</span>
                            <span><span class="inline-block w-2 h-2 rounded-full mr-1" style="background:#f472b6"></span>Skill</span>
                            <span><span class="inline-block w-2 h-2 rounded-full mr-1" style="background:#ff6b35"></span>Agent</span>
                        </div>
                    </div>
                    <div class="glass-card rounded-xl overflow-hidden" style="background: #0a0e14;">
                        <svg :viewBox="'0 0 1200 ' + factorySvgHeight" style="width:100%; height:auto;" xmlns="http://www.w3.org/2000/svg">
                            <!-- Sky background -->
                            <rect x="0" y="0" :width="1200" :height="factorySvgHeight" class="factory-sky"/>

                            <!-- Content level label -->
                            <text x="20" y="55" class="level-label">Content</text>

                            <!-- Content pipes (elevated  tasks, memory, skill) -->
                            <template v-for="(pipe, idx) in factoryContentPipes" :key="'cp-'+pipe.name">
                                <g @click="onPipeClick(pipe, $event)">
                                    <rect class="pipe-body" :x="120" :y="pipe.y" :width="960" :height="pipe.thickness" :rx="pipe.thickness/2"
                                        :fill="pipe.color" :opacity="pipe.stale ? 0.25 : 0.7"/>
                                    <rect v-if="pipe.stale" :x="120" :y="pipe.y" :width="960" :height="pipe.thickness" :rx="pipe.thickness/2"
                                        fill="none" :stroke="pipe.color" stroke-width="1" stroke-dasharray="6 4" opacity="0.5"/>
                                    <text class="pipe-label" :x="115" :y="pipe.y + pipe.thickness/2 + 3" text-anchor="end">{{ pipe.shortName }}</text>
                                    <text class="pipe-count" :x="1090" :y="pipe.y + pipe.thickness/2 + 3">{{ pipe.msgCount }}</text>
                                    <!-- Animated particles for active pipes -->
                                    <template v-if="!pipe.stale">
                                        <circle v-for="p in pipe.particles" :key="p" :r="pipe.thickness/3" :fill="pipe.color" opacity="0.9">
                                            <animateMotion :dur="(3 + p * 0.7) + 's'" repeatCount="indefinite" :begin="(p * 1.1) + 's'"
                                                :path="'M120,' + (pipe.y + pipe.thickness/2) + ' L1080,' + (pipe.y + pipe.thickness/2)" />
                                        </circle>
                                    </template>
                                </g>
                            </template>

                            <!-- Support stilts -->
                            <line v-for="sx in [200, 400, 600, 800, 1000]" :key="'stilt-'+sx"
                                :x1="sx" :y1="factoryStiltTop" :x2="sx" :y2="factoryGroundY - 20"
                                class="support-stilt"/>
                            <line :x1="180" :y1="factoryStiltTop" :x2="1020" :y2="factoryStiltTop"
                                class="support-stilt"/>

                            <!-- Infra level label -->
                            <text x="20" :y="factoryInfraLabelY" class="level-label">Infra</text>

                            <!-- Infra pipes (ground level  control, observe) -->
                            <template v-for="(pipe, idx) in factoryInfraPipes" :key="'ip-'+pipe.name">
                                <g @click="onPipeClick(pipe, $event)">
                                    <rect class="pipe-body" :x="120" :y="pipe.y" :width="960" :height="pipe.thickness" :rx="pipe.thickness/2"
                                        :fill="pipe.color" :opacity="pipe.stale ? 0.25 : 0.7"/>
                                    <rect v-if="pipe.stale" :x="120" :y="pipe.y" :width="960" :height="pipe.thickness" :rx="pipe.thickness/2"
                                        fill="none" :stroke="pipe.color" stroke-width="1" stroke-dasharray="6 4" opacity="0.5"/>
                                    <text class="pipe-label" :x="115" :y="pipe.y + pipe.thickness/2 + 3" text-anchor="end">{{ pipe.shortName }}</text>
                                    <text class="pipe-count" :x="1090" :y="pipe.y + pipe.thickness/2 + 3">{{ pipe.msgCount }}</text>
                                    <template v-if="!pipe.stale">
                                        <circle v-for="p in pipe.particles" :key="p" :r="pipe.thickness/3" :fill="pipe.color" opacity="0.9">
                                            <animateMotion :dur="(3 + p * 0.7) + 's'" repeatCount="indefinite" :begin="(p * 1.1) + 's'"
                                                :path="'M120,' + (pipe.y + pipe.thickness/2) + ' L1080,' + (pipe.y + pipe.thickness/2)" />
                                        </circle>
                                    </template>
                                </g>
                            </template>

                            <!-- Ground line -->
                            <rect x="0" :y="factoryGroundY" width="1200" height="4" fill="#30363d" rx="2"/>

                            <!-- Agent stations -->
                            <template v-for="(ag, idx) in factoryAgents" :key="'ag-'+ag.id">
                                <g>
                                    <!-- Vertical connector (dashed) -->
                                    <line :x1="agentX(idx)" y1="40" :x2="agentX(idx)" :y2="factoryGroundY + 20"
                                        stroke="#30363d" stroke-width="1" stroke-dasharray="3 3" opacity="0.4"/>
                                    <!-- Junction dots on content pipes -->
                                    <template v-for="jp in agentJunctions(ag)" :key="'jn-'+ag.id+'-'+jp.name">
                                        <circle :cx="agentX(idx)" :cy="jp.y + jp.thickness/2" r="4" :fill="jp.color" opacity="0.8"/>
                                    </template>
                                    <!-- Pump station -->
                                    <rect :x="agentX(idx) - 18" :y="factoryGroundY + 16" width="36" height="24" rx="4"
                                        fill="#ff6b35" opacity="0.8"/>
                                    <circle :cx="agentX(idx)" :cy="factoryGroundY + 28" r="6" fill="#0d1117" opacity="0.6"/>
                                    <circle :cx="agentX(idx)" :cy="factoryGroundY + 28" r="3" fill="#ff6b35"/>
                                    <!-- Agent label -->
                                    <text class="agent-label" :x="agentX(idx)" :y="factoryGroundY + 54">{{ ag.shortName }}</text>
                                </g>
                            </template>
                        </svg>
                    </div>
                </div>

                <!-- Density Popup -->
                <div v-if="factorySelectedPipe" class="density-popup glass rounded-xl border border-gray-700 shadow-2xl p-4"
                    :style="{ left: factoryPipePosition.x + 'px', top: factoryPipePosition.y + 'px', width: '340px' }"
                    @click.stop>
                    <div class="flex items-center justify-between mb-3">
                        <div class="text-xs font-semibold text-white">{{ factorySelectedPipe }}</div>
                        <button @click="factorySelectedPipe = null" class="text-gray-500 hover:text-white text-sm">&times;</button>
                    </div>
                    <div v-if="densityLoading" class="text-[10px] text-gray-500 py-4 text-center">Loading...</div>
                    <template v-else>
                        <!-- Sparkline -->
                        <div v-if="densityData.length > 0" class="mb-3">
                            <svg viewBox="0 0 300 60" style="width:100%;height:60px;">
                                <path :d="densitySparklineArea()" :fill="densityColor" class="sparkline-area"/>
                                <path :d="densitySparklinePath()" :stroke="densityColor" class="sparkline-line"/>
                            </svg>
                            <div class="flex justify-between text-[9px] text-gray-600 mt-1">
                                <span>{{ densityData[0]?.bucket_start?.slice(5,16) || '' }}</span>
                                <span>now</span>
                            </div>
                        </div>
                        <div v-else class="text-[10px] text-gray-600 mb-3 italic">No density data</div>
                        <!-- Envelope type tags -->
                        <div v-if="Object.keys(envelopeTypes).length > 0" class="mb-2">
                            <div class="text-[9px] text-gray-500 uppercase tracking-wider mb-1">Envelope Types</div>
                            <div class="flex flex-wrap">
                                <span v-for="(cnt, etype) in envelopeTypes" :key="etype" class="env-tag"
                                    :style="{ fontSize: tagFontSize(cnt) + 'px' }">
                                    {{ etype }} <span class="text-gray-600">{{ cnt }}</span>
                                </span>
                            </div>
                        </div>
                        <!-- Quick stats -->
                        <div class="flex gap-3 text-[10px] text-gray-500 mt-2 pt-2 border-t border-gray-800">
                            <span>Total: {{ densityData.reduce((s, b) => s + b.count, 0) }}</span>
                            <span>24h: {{ densityData.slice(-24).reduce((s, b) => s + b.count, 0) }}</span>
                        </div>
                    </template>
                </div>

                <!-- Section B: Gamification Bar -->
                <div class="max-w-7xl mx-auto" v-if="xpLeaderboard.length > 0">
                    <div class="text-xs text-gray-400 uppercase tracking-wider font-semibold mb-3">XP Leaderboard</div>
                    <div class="flex gap-4 overflow-x-auto pb-2">
                        <div v-for="(agent, idx) in xpLeaderboard" :key="agent.agent_id"
                            class="glass-card rounded-lg p-4 min-w-[220px] flex-shrink-0">
                            <div class="flex items-center gap-2 mb-2">
                                <div class="w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold"
                                    :style="{ background: getRankBg(agent.rank), color: getRankColor(agent.rank) }">
                                    {{ idx + 1 }}
                                </div>
                                <div>
                                    <div class="text-xs font-semibold text-white truncate" style="max-width:140px">{{ agent.agent_name || agent.agent_id }}</div>
                                    <div class="text-[10px]" :class="'rank-' + agent.rank.toLowerCase()">{{ agent.rank }}</div>
                                </div>
                            </div>
                            <div class="xp-bar mb-1">
                                <div class="xp-fill" :style="{ width: getXPPercent(agent) + '%', background: getRankColor(agent.rank) }"></div>
                            </div>
                            <div class="flex items-center justify-between text-[10px] text-gray-500 mb-2">
                                <span>Level {{ agent.level }}</span>
                                <span>{{ agent.total_xp }} XP</span>
                            </div>
                            <div class="grid grid-cols-2 gap-1 text-[9px] text-gray-500">
                                <span>Tasks: {{ agent.tasks_completed }}</span>
                                <span>Traces: {{ agent.traces_shared }}</span>
                                <span>Memory: {{ agent.memories_shared }}</span>
                                <span>Skills: {{ agent.skills_registered }}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Section C: Topic Registry -->
                <div class="max-w-7xl mx-auto">
                    <div class="flex items-center justify-between mb-3">
                        <div class="text-xs text-gray-400 uppercase tracking-wider font-semibold">Topic Registry</div>
                        <div class="flex gap-1">
                            <button v-for="cat in ['all','control','tasks','observe','memory','skill']" :key="cat"
                                @click="topicCategoryFilter = cat"
                                class="btn-ghost text-[10px] px-2 py-1"
                                :style="topicCategoryFilter === cat ? { color: getCategoryColor(cat), borderColor: getCategoryColor(cat), background: getCategoryColor(cat) + '14' } : {}">
                                {{ cat.toUpperCase() }}
                            </button>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div v-for="topic in filteredTopics" :key="topic.name"
                            class="glass-card rounded-lg p-4"
                            :class="topic.health && topic.health.is_stale ? 'topic-pulse' : ''">

                            <div class="flex items-center gap-2 mb-2">
                                <span class="badge" :class="'badge-' + topic.category">{{ topic.category }}</span>
                                <span class="text-xs font-semibold text-white truncate flex-1">{{ topic.name.split('.').slice(-1)[0] }}</span>
                            </div>
                            <div class="text-[10px] text-gray-500 mb-3">{{ topic.description }}</div>

                            <div v-if="topic.stats" class="space-y-2">
                                <div class="flex items-center gap-3 text-[10px]">
                                    <span class="text-gray-400">{{ topic.stats.message_count || 0 }} msgs</span>
                                    <span class="text-gray-500">24h: {{ topic.stats.last_24h || 0 }}</span>
                                    <span class="text-gray-500">7d: {{ topic.stats.last_7d || 0 }}</span>
                                </div>
                                <div class="flex items-center gap-3 text-[10px]">
                                    <span class="text-gray-400">Agents: {{ topic.stats.unique_agents || 0 }}</span>
                                    <span v-if="topic.stats.last_message_at" class="text-gray-500">Last: {{ relativeTime(topic.stats.last_message_at) }}</span>
                                </div>
                            </div>
                            <div v-else class="text-[10px] text-gray-600 italic">No messages yet</div>

                            <!-- Health bar -->
                            <div v-if="topic.health" class="mt-2">
                                <div class="flex items-center justify-between text-[9px] text-gray-500 mb-1">
                                    <span>Health</span>
                                    <span>{{ topic.health.score }}%</span>
                                </div>
                                <div class="health-bar">
                                    <div class="health-fill" :style="{ width: topic.health.score + '%', background: topic.health.score > 70 ? '#22c55e' : topic.health.score > 40 ? '#eab308' : '#ef4444' }"></div>
                                </div>
                            </div>

                            <!-- Consumers -->
                            <div v-if="topic.consumers && topic.consumers.length" class="mt-2 flex flex-wrap gap-1">
                                <span v-for="c in topic.consumers" :key="c" class="pill">{{ c }}</span>
                            </div>

                            <!-- Actions -->
                            <div class="flex gap-2 mt-3">
                                <button v-if="topic.stats && topic.stats.message_count > 0"
                                    @click="browseTopic(topic.name)" class="btn-ghost text-[10px] px-2 py-1">BROWSE</button>
                                <button v-if="!topic.stats || topic.stats.message_count === 0"
                                    @click="ensureTopic(topic.name)" class="btn-primary text-[10px] px-2 py-1">CREATE</button>
                            </div>

                            <!-- Browse panel -->
                            <div v-if="selectedTopic === topic.name && topicMessages.length > 0" class="mt-3 space-y-1 max-h-48 overflow-y-auto border-t border-gray-800 pt-2">
                                <div v-for="msg in topicMessages" :key="msg.id" class="text-[10px] flex items-center gap-2 py-1">
                                    <span class="text-gray-600">{{ relativeTime(msg.created_at) }}</span>
                                    <span class="text-amber-400">{{ msg.sender_id.split('-').slice(-1)[0] }}</span>
                                    <span class="text-gray-400">{{ msg.envelope_type }}</span>
                                    <span class="text-gray-600">{{ msg.payload_size }}b</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Config Tab -->
            <div v-if="activeTab === 'config'" class="max-w-2xl mx-auto space-y-4">
                <div class="glass-card rounded-lg p-6 space-y-4">
                    <div class="text-xs text-gray-400 uppercase tracking-wider font-semibold mb-2">Group Configuration</div>

                    <div class="space-y-3">
                        <div>
                            <label class="text-[10px] text-gray-500 uppercase tracking-wider block mb-1">LFS Proxy URL</label>
                            <input v-model="configForm.lfs_proxy_url" class="input-field w-full" placeholder="http://localhost:8080">
                        </div>
                        <div>
                            <label class="text-[10px] text-gray-500 uppercase tracking-wider block mb-1">API Key</label>
                            <input v-model="configForm.api_key" type="password" class="input-field w-full" placeholder="API key (masked)">
                        </div>
                        <div>
                            <label class="text-[10px] text-gray-500 uppercase tracking-wider block mb-1">Kafka Brokers</label>
                            <input v-model="configForm.kafka_brokers" class="input-field w-full" placeholder="localhost:9092">
                        </div>
                        <div>
                            <label class="text-[10px] text-gray-500 uppercase tracking-wider block mb-1">Consumer Group</label>
                            <input v-model="configForm.consumer_group" class="input-field w-full" placeholder="consumer group">
                        </div>
                        <div>
                            <label class="text-[10px] text-gray-500 uppercase tracking-wider block mb-1">Agent ID</label>
                            <input v-model="configForm.agent_id" class="input-field w-full" placeholder="agent ID">
                        </div>
                        <div>
                            <label class="text-[10px] text-gray-500 uppercase tracking-wider block mb-1">Poll Interval (ms)</label>
                            <input v-model="configForm.poll_interval_ms" type="number" class="input-field w-full" placeholder="2000">
                        </div>
                    </div>

                    <div class="flex items-center justify-between pt-2">
                        <div v-if="configSaved" class="text-[11px]" :class="configRequiresRejoin ? 'text-amber-400' : 'text-green-400'">
                            {{ configRequiresRejoin ? 'Saved. Rejoin required for changes to take effect.' : 'Saved.' }}
                        </div>
                        <div v-else></div>
                        <button @click="saveConfig" :disabled="savingConfig" class="btn-primary">
                            {{ savingConfig ? 'SAVING...' : 'SAVE CONFIG' }}
                        </button>
                    </div>
                </div>
            </div>

        </main>

        <!-- Join Modal -->
        <div v-if="showJoinModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/60" @click.self="showJoinModal = false">
            <div class="glass rounded-xl border border-gray-700 shadow-2xl p-6" style="width: 420px; max-width: 92vw;">
                <div class="flex items-center justify-between mb-4">
                    <div class="text-sm font-bold text-amber-400 tracking-widest">JOIN GROUP</div>
                    <button @click="showJoinModal = false" class="text-gray-500 hover:text-white text-lg">&times;</button>
                </div>
                <div class="space-y-3">
                    <div>
                        <label class="text-[10px] text-gray-500 uppercase tracking-wider block mb-1">Group Name *</label>
                        <input v-model="joinForm.group_name" class="input-field w-full" placeholder="my-agent-team" @keyup.enter="joinGroup" @focus="fillDefault('joinForm', 'group_name', 'my-agent-team')">
                    </div>
                    <div>
                        <label class="text-[10px] text-gray-500 uppercase tracking-wider block mb-1">LFS Proxy URL</label>
                        <input v-model="joinForm.lfs_proxy_url" class="input-field w-full" placeholder="http://localhost:8080" @focus="fillDefault('joinForm', 'lfs_proxy_url', 'http://localhost:8080')">
                    </div>
                    <div>
                        <label class="text-[10px] text-gray-500 uppercase tracking-wider block mb-1">Kafka Brokers</label>
                        <input v-model="joinForm.kafka_brokers" class="input-field w-full" placeholder="localhost:9092" @focus="fillDefault('joinForm', 'kafka_brokers', 'localhost:9092')">
                    </div>
                    <div>
                        <label class="text-[10px] text-gray-500 uppercase tracking-wider block mb-1">Agent ID (optional)</label>
                        <input v-model="joinForm.agent_id" class="input-field w-full" placeholder="auto-generated if empty">
                    </div>
                </div>
                <div v-if="joinError" class="text-xs text-red-400 mt-3">{{ joinError }}</div>
                <div class="flex justify-end gap-2 mt-5">
                    <button @click="showJoinModal = false" class="btn-ghost">Cancel</button>
                    <button @click="joinGroup" :disabled="!joinForm.group_name.trim() || joining" class="btn-primary">
                        {{ joining ? 'JOINING...' : 'JOIN' }}
                    </button>
                </div>
            </div>
        </div>

        <!-- Toast -->
        <div v-if="toast" class="fixed bottom-6 right-6 z-50 glass rounded-lg px-4 py-3 shadow-xl border"
            :class="toast.type === 'error' ? 'border-red-800 text-red-400' : 'border-green-800 text-green-400'">
            <div class="text-xs font-medium">{{ toast.message }}</div>
        </div>

    </div>

    <script>
    const { createApp, ref, reactive, computed, onMounted, onUnmounted, watch } = Vue

    createApp({
        setup() {
            const tabs = [
                { id: 'overview', label: 'Overview' },
                { id: 'members', label: 'Members' },
                { id: 'topics', label: 'Topics' },
                { id: 'tasks', label: 'Tasks' },
                { id: 'traces', label: 'Traces' },
                { id: 'audit', label: 'Audit' },
                { id: 'config', label: 'Config' },
            ]
            const activeTab = ref('overview')

            // State
            const status = ref({ active: false, group_name: '', member_count: 0, agent_id: '', lfs_proxy_url: '', lfs_healthy: false })
            const members = ref([])
            const tasks = ref([])
            const traces = ref([])
            const config = ref({})
            const groupActive = computed(() => status.value.active === true)

            // UI state
            const showJoinModal = ref(false)
            const joining = ref(false)
            const leaving = ref(false)
            const joinError = ref('')
            const quickJoinName = ref('')
            const toast = ref(null)
            const expandedTasks = reactive({})
            const expandedTraces = reactive({})

            // Stats & audit state
            const stats = ref(null)
            const previousMembers = ref([])
            const membershipHistory = ref([])
            const auditEntries = ref([])
            const auditSourceFilter = ref('')
            const auditAgentFilter = ref('')
            const filteredAuditEntries = computed(() => {
                let entries = auditEntries.value
                if (auditSourceFilter.value) {
                    entries = entries.filter(e => e.source === auditSourceFilter.value)
                }
                if (auditAgentFilter.value) {
                    const q = auditAgentFilter.value.toLowerCase()
                    entries = entries.filter(e => (e.agent_id || '').toLowerCase().includes(q))
                }
                return entries
            })

            // Topics state
            const topicsData = ref([])
            const skillTopicsData = ref([])
            const topicFlow = ref([])
            const topicHealth = ref([])
            const xpLeaderboard = ref([])
            const topicCategoryFilter = ref('all')
            const selectedTopic = ref(null)
            const topicMessages = ref([])
            // Factory pipe visualization state
            const factorySelectedPipe = ref(null)
            const factoryPipePosition = reactive({ x: 200, y: 200 })
            const densityData = ref([])
            const envelopeTypes = ref({})
            const densityLoading = ref(false)
            const densityColor = ref('#58a6ff')

            const filteredTopics = computed(() => {
                const all = [...topicsData.value, ...skillTopicsData.value]
                if (topicCategoryFilter.value === 'all') return all
                return all.filter(t => t.category === topicCategoryFilter.value)
            })

            // Task form
            const taskDescription = ref('')
            const taskContent = ref('')
            const submittingTask = ref(false)
            const taskFilter = ref('')
            const taskStatusFilter = ref('')

            // Trace filter
            const traceAgentFilter = ref('')
            const traceAgents = computed(() => {
                const agents = new Set(traces.value.map(t => t.source_agent_id))
                return [...agents].sort()
            })

            // Local end-to-end traces (from agent tasks)
            const localTasks = ref([])
            const expandedLocalTrace = ref(null)
            const localTraceSpans = ref([])
            const localTraceTask = ref(null)
            const localTracePolicy = ref([])
            const localTraceLoading = ref(false)
            const selectedLocalSpan = ref(null)

            // Config form
            const configForm = reactive({ lfs_proxy_url: '', api_key: '', kafka_brokers: '', consumer_group: '', agent_id: '', poll_interval_ms: '' })
            const savingConfig = ref(false)
            const configSaved = ref(false)
            const configRequiresRejoin = ref(false)

            // Join form
            const joinForm = reactive({ group_name: '', lfs_proxy_url: '', kafka_brokers: '', agent_id: '' })

            // Polling
            let pollTimer = null

            function showToast(message, type = 'success') {
                toast.value = { message, type }
                setTimeout(() => { toast.value = null }, 3000)
            }

            async function loadStatus() {
                try {
                    const res = await fetch('/api/v1/group/status')
                    status.value = await res.json()
                } catch (e) { /* ignore */ }
            }

            async function loadMembers() {
                try {
                    const res = await fetch('/api/v1/group/members')
                    const data = await res.json()
                    members.value = Array.isArray(data) ? data : []
                } catch (e) {
                    console.warn('loadMembers error:', e)
                }
            }

            async function loadTasks() {
                try {
                    let url = '/api/v1/group/tasks?limit=100'
                    if (taskFilter.value) url += '&direction=' + taskFilter.value
                    if (taskStatusFilter.value) url += '&status=' + taskStatusFilter.value
                    const res = await fetch(url)
                    tasks.value = await res.json()
                } catch (e) { /* ignore */ }
            }

            async function loadTraces() {
                try {
                    let url = '/api/v1/group/traces?limit=100'
                    if (traceAgentFilter.value) url += '&agent_id=' + encodeURIComponent(traceAgentFilter.value)
                    const res = await fetch(url)
                    traces.value = await res.json()
                } catch (e) { /* ignore */ }
            }

            async function loadLocalTasks() {
                try {
                    const res = await fetch('/api/v1/tasks?limit=50')
                    localTasks.value = await res.json()
                } catch (e) { /* ignore */ }
            }

            async function expandLocalTrace(traceId) {
                if (expandedLocalTrace.value === traceId) {
                    expandedLocalTrace.value = null
                    return
                }
                expandedLocalTrace.value = traceId
                localTraceSpans.value = []
                localTraceTask.value = null
                localTracePolicy.value = []
                localTraceLoading.value = true
                selectedLocalSpan.value = null
                try {
                    const res = await fetch('/api/v1/trace/' + encodeURIComponent(traceId))
                    const data = await res.json()
                    localTraceSpans.value = (data.spans || []).sort((a, b) => a.time.localeCompare(b.time))
                    localTraceTask.value = data.task || null
                    localTracePolicy.value = data.policy_decisions || []
                } catch (e) { /* ignore */ }
                localTraceLoading.value = false
            }

            function spanTypeColor(type) {
                const map = { INBOUND: '#58a6ff', LLM: '#a855f7', TOOL: '#fb923c', OUTBOUND: '#22c55e', POLICY: '#ef4444' }
                return map[type] || '#6366f1'
            }

            async function loadConfig() {
                try {
                    const res = await fetch('/api/v1/group/config')
                    const data = await res.json()
                    config.value = data
                    configForm.lfs_proxy_url = data.lfs_proxy_url || ''
                    configForm.api_key = ''
                    configForm.kafka_brokers = data.kafka_brokers || ''
                    configForm.consumer_group = data.consumer_group || ''
                    configForm.agent_id = data.agent_id || ''
                    configForm.poll_interval_ms = data.poll_interval_ms || ''
                } catch (e) { /* ignore */ }
            }

            async function loadAll() {
                await loadStatus()
                await loadMembers()
                await loadStats()
                await loadPreviousMembers()
            }

            async function joinGroup() {
                if (!joinForm.group_name.trim()) return
                joining.value = true
                joinError.value = ''
                try {
                    const res = await fetch('/api/v1/group/join', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(joinForm),
                    })
                    if (!res.ok) {
                        joinError.value = await res.text()
                        return
                    }
                    status.value = await res.json()
                    showJoinModal.value = false
                    joinForm.group_name = ''
                    joinForm.lfs_proxy_url = ''
                    joinForm.kafka_brokers = ''
                    joinForm.agent_id = ''
                    showToast('Joined group: ' + status.value.group_name)
                    await loadAll()
                    await loadConfig()
                } catch (e) {
                    joinError.value = e.message
                } finally {
                    joining.value = false
                }
            }

            async function quickJoin() {
                joinForm.group_name = quickJoinName.value
                await joinGroup()
                quickJoinName.value = ''
            }

            async function leaveGroup() {
                leaving.value = true
                try {
                    const res = await fetch('/api/v1/group/leave', { method: 'POST' })
                    if (!res.ok) {
                        showToast(await res.text(), 'error')
                        return
                    }
                    showToast('Left group')
                    await loadAll()
                } catch (e) {
                    showToast(e.message, 'error')
                } finally {
                    leaving.value = false
                }
            }

            async function submitTask() {
                if (!taskDescription.value.trim()) return
                submittingTask.value = true
                try {
                    const res = await fetch('/api/v1/group/tasks/submit', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ description: taskDescription.value, content: taskContent.value }),
                    })
                    if (!res.ok) {
                        showToast(await res.text(), 'error')
                        return
                    }
                    const data = await res.json()
                    showToast('Task submitted: ' + data.task_id)
                    taskDescription.value = ''
                    taskContent.value = ''
                    await loadTasks()
                } catch (e) {
                    showToast(e.message, 'error')
                } finally {
                    submittingTask.value = false
                }
            }

            async function saveConfig() {
                savingConfig.value = true
                configSaved.value = false
                try {
                    const body = {}
                    if (configForm.lfs_proxy_url) body.lfs_proxy_url = configForm.lfs_proxy_url
                    if (configForm.api_key) body.api_key = configForm.api_key
                    if (configForm.kafka_brokers) body.kafka_brokers = configForm.kafka_brokers
                    if (configForm.consumer_group) body.consumer_group = configForm.consumer_group
                    if (configForm.agent_id) body.agent_id = configForm.agent_id
                    if (configForm.poll_interval_ms) body.poll_interval_ms = String(configForm.poll_interval_ms)

                    const res = await fetch('/api/v1/group/config', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(body),
                    })
                    if (!res.ok) {
                        showToast(await res.text(), 'error')
                        return
                    }
                    const data = await res.json()
                    configSaved.value = true
                    configRequiresRejoin.value = data.requires_rejoin === true
                } catch (e) {
                    showToast(e.message, 'error')
                } finally {
                    savingConfig.value = false
                }
            }

            async function loadStats() {
                try {
                    const res = await fetch('/api/v1/group/stats')
                    stats.value = await res.json()
                } catch (e) { /* ignore */ }
            }

            async function loadPreviousMembers() {
                try {
                    const res = await fetch('/api/v1/group/members/previous')
                    previousMembers.value = await res.json()
                } catch (e) { /* ignore */ }
            }

            async function loadMembershipHistory() {
                try {
                    const res = await fetch('/api/v1/group/membership/history?limit=50')
                    membershipHistory.value = await res.json()
                } catch (e) { /* ignore */ }
            }

            async function rejoinGroup(agentID) {
                try {
                    const res = await fetch('/api/v1/group/rejoin', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ agent_id: agentID }),
                    })
                    if (!res.ok) {
                        showToast(await res.text(), 'error')
                        return
                    }
                    showToast('Rejoined: ' + agentID)
                    await loadAll()
                    await loadPreviousMembers()
                } catch (e) {
                    showToast(e.message, 'error')
                }
            }

            async function loadAudit() {
                try {
                    const res = await fetch('/api/v1/group/audit?limit=200')
                    auditEntries.value = await res.json()
                } catch (e) { /* ignore */ }
            }

            // --- Topics functions ---
            async function loadTopics() {
                try {
                    const res = await fetch('/api/v1/group/topics')
                    const data = await res.json()
                    topicsData.value = data.topics || []
                    skillTopicsData.value = data.skill_topics || []
                    xpLeaderboard.value = data.xp_leaderboard || []
                } catch (e) { /* ignore */ }
            }

            async function loadTopicFlow() {
                try {
                    const res = await fetch('/api/v1/group/topics/flow')
                    const data = await res.json()
                    topicFlow.value = data.edges || []
                } catch (e) { /* ignore */ }
            }

            async function loadTopicHealth() {
                try {
                    const res = await fetch('/api/v1/group/topics/health')
                    const data = await res.json()
                    topicHealth.value = data.health || []
                } catch (e) { /* ignore */ }
            }

            async function ensureTopic(topicName) {
                try {
                    const res = await fetch('/api/v1/group/topics/ensure', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ topic_name: topicName })
                    })
                    const data = await res.json()
                    if (data.ok) {
                        showToast('Topic created: ' + topicName)
                        await loadTopics()
                        await loadTopicHealth()
                        // Auto-open browse panel for the newly created topic
                        await browseTopic(topicName)
                    } else {
                        showToast(data.error || 'Failed', 'error')
                    }
                } catch (e) { showToast('Failed to create topic', 'error') }
            }

            async function browseTopic(topicName) {
                if (selectedTopic.value === topicName) {
                    selectedTopic.value = null
                    topicMessages.value = []
                    return
                }
                selectedTopic.value = topicName
                try {
                    const res = await fetch('/api/v1/group/topics?browse=' + encodeURIComponent(topicName) + '&limit=50')
                    const data = await res.json()
                    topicMessages.value = data.messages || []
                } catch (e) { topicMessages.value = [] }
            }

            function getRankColor(rank) {
                const map = { Bronze: '#cd7f32', Silver: '#c0c0c0', Gold: '#ffd700', Diamond: '#b9f2ff' }
                return map[rank] || '#6b7280'
            }

            function getRankBg(rank) {
                const map = { Bronze: 'rgba(205,127,50,0.2)', Silver: 'rgba(192,192,192,0.2)', Gold: 'rgba(255,215,0,0.2)', Diamond: 'rgba(185,242,255,0.2)' }
                return map[rank] || 'rgba(107,114,128,0.2)'
            }

            function getXPPercent(agent) {
                const level = agent.level || 0
                const nextLevelXP = (level + 1) * (level + 1) * 10
                const currLevelXP = level * level * 10
                const progress = (agent.total_xp - currLevelXP) / (nextLevelXP - currLevelXP) * 100
                return Math.min(100, Math.max(0, progress))
            }

            function getCategoryColor(cat) {
                const map = { all: '#f59e0b', control: '#58a6ff', tasks: '#fbbf24', observe: '#a855f7', memory: '#22c55e', skill: '#f472b6' }
                return map[cat] || '#6b7280'
            }

            // --- Factory pipe layout computations ---
            function buildPipe(topic, yPos) {
                const mph = topic.health ? topic.health.messages_per_hour : 0
                const thickness = Math.max(6, Math.min(24, 6 + Math.log2(mph + 1) * 4))
                const stale = topic.health ? topic.health.is_stale : true
                const particles = stale ? [] : Array.from({ length: Math.min(3, Math.max(1, Math.ceil(mph))) }, (_, i) => i)
                return {
                    name: topic.name,
                    shortName: (topic.name || '').split('.').slice(-1)[0],
                    category: topic.category,
                    color: getCategoryColor(topic.category),
                    y: yPos,
                    thickness,
                    stale,
                    msgCount: topic.stats ? topic.stats.message_count : 0,
                    particles,
                    consumers: topic.consumers || [],
                }
            }

            const factoryContentPipes = computed(() => {
                const allTopics = [...topicsData.value, ...skillTopicsData.value]
                const content = allTopics.filter(t => ['tasks', 'memory', 'skill'].includes(t.category))
                const pipes = []
                let y = 65
                content.forEach(t => {
                    const p = buildPipe(t, y)
                    pipes.push(p)
                    y += p.thickness + 10
                })
                return pipes
            })

            const factoryStiltTop = computed(() => {
                const pipes = factoryContentPipes.value
                if (pipes.length === 0) return 120
                const last = pipes[pipes.length - 1]
                return last.y + last.thickness + 20
            })

            const factoryInfraLabelY = computed(() => factoryStiltTop.value + 35)

            const factoryInfraPipes = computed(() => {
                const allTopics = [...topicsData.value, ...skillTopicsData.value]
                const infra = allTopics.filter(t => ['control', 'observe'].includes(t.category))
                const pipes = []
                let y = factoryInfraLabelY.value + 15
                infra.forEach(t => {
                    const p = buildPipe(t, y)
                    pipes.push(p)
                    y += p.thickness + 10
                })
                return pipes
            })

            const factoryGroundY = computed(() => {
                const pipes = factoryInfraPipes.value
                if (pipes.length === 0) return factoryInfraLabelY.value + 60
                const last = pipes[pipes.length - 1]
                return last.y + last.thickness + 30
            })

            const factorySvgHeight = computed(() => factoryGroundY.value + 70)

            const factoryAgents = computed(() => {
                const seen = new Set()
                const agents = []
                // From XP leaderboard
                xpLeaderboard.value.forEach(a => {
                    if (!seen.has(a.agent_id)) {
                        agents.push({ id: a.agent_id, shortName: (a.agent_name || a.agent_id).split('-').slice(-1)[0] })
                        seen.add(a.agent_id)
                    }
                })
                // From members
                members.value.forEach(m => {
                    if (!seen.has(m.agent_id)) {
                        agents.push({ id: m.agent_id, shortName: (m.agent_name || m.agent_id).split('-').slice(-1)[0] })
                        seen.add(m.agent_id)
                    }
                })
                return agents
            })

            function agentX(idx) {
                const count = factoryAgents.value.length || 1
                const spacing = 900 / (count + 1)
                return 150 + spacing * (idx + 1)
            }

            function agentJunctions(agent) {
                const allPipes = [...factoryContentPipes.value, ...factoryInfraPipes.value]
                // Match via flow data
                const agentTopics = new Set()
                topicFlow.value.forEach(f => {
                    if (f.source_agent_id === agent.id || f.target_agent_id === agent.id) {
                        agentTopics.add(f.topic_name)
                    }
                })
                // Fallback: match via consumer lists
                allPipes.forEach(p => {
                    if (p.consumers && p.consumers.includes(agent.id)) {
                        agentTopics.add(p.name)
                    }
                })
                return allPipes.filter(p => agentTopics.has(p.name))
            }

            async function onPipeClick(pipe, event) {
                factorySelectedPipe.value = pipe.name
                densityColor.value = pipe.color
                // Position popup near click
                const rect = event.target.closest('svg').getBoundingClientRect()
                factoryPipePosition.x = Math.min(event.clientX, window.innerWidth - 360)
                factoryPipePosition.y = Math.min(event.clientY + 10, window.innerHeight - 300)
                // Fetch density data
                densityLoading.value = true
                try {
                    const res = await fetch('/api/v1/group/topics/density?topic=' + encodeURIComponent(pipe.name) + '&hours=48')
                    const data = await res.json()
                    densityData.value = data.buckets || []
                    envelopeTypes.value = data.envelope_types || {}
                } catch (e) {
                    densityData.value = []
                    envelopeTypes.value = {}
                } finally {
                    densityLoading.value = false
                }
            }

            function densitySparklinePath() {
                const buckets = densityData.value
                if (!buckets.length) return ''
                const max = Math.max(1, ...buckets.map(b => b.count))
                const w = 300, h = 55
                return buckets.map((b, i) => {
                    const x = (i / (buckets.length - 1)) * w
                    const y = h - (b.count / max) * (h - 5)
                    return (i === 0 ? 'M' : 'L') + x.toFixed(1) + ',' + y.toFixed(1)
                }).join(' ')
            }

            function densitySparklineArea() {
                const buckets = densityData.value
                if (!buckets.length) return ''
                const max = Math.max(1, ...buckets.map(b => b.count))
                const w = 300, h = 55
                let path = 'M0,' + h
                buckets.forEach((b, i) => {
                    const x = (i / (buckets.length - 1)) * w
                    const y = h - (b.count / max) * (h - 5)
                    path += ' L' + x.toFixed(1) + ',' + y.toFixed(1)
                })
                path += ' L' + w + ',' + h + ' Z'
                return path
            }

            function tagFontSize(count) {
                const allCounts = Object.values(envelopeTypes.value)
                const max = Math.max(1, ...allCounts)
                return Math.max(9, Math.min(16, 9 + (count / max) * 7))
            }

            function formatDuration(secs) {
                if (!secs || secs === 0) return '---'
                if (secs < 60) return Math.round(secs) + 's'
                if (secs < 3600) return Math.round(secs / 60) + 'm'
                return Math.round(secs / 3600) + 'h'
            }

            function fillDefault(formName, field, defaultVal) {
                const form = formName === 'joinForm' ? joinForm : configForm
                if (!form[field]) form[field] = defaultVal
            }

            function toggleTaskExpand(id) {
                expandedTasks[id] = !expandedTasks[id]
            }

            function toggleTraceExpand(id) {
                expandedTraces[id] = !expandedTraces[id]
            }

            function parseCaps(capsStr) {
                try { const v = JSON.parse(capsStr || '[]'); return Array.isArray(v) ? v : [] } catch { return [] }
            }

            function parseChannels(chStr) {
                try { const v = JSON.parse(chStr || '[]'); return Array.isArray(v) ? v : [] } catch { return [] }
            }

            function relativeTime(dateStr) {
                if (!dateStr) return 'never'
                const date = new Date(dateStr)
                const now = new Date()
                const diff = Math.floor((now - date) / 1000)
                if (diff < 10) return 'just now'
                if (diff < 60) return diff + 's ago'
                if (diff < 3600) return Math.floor(diff / 60) + 'm ago'
                if (diff < 86400) return Math.floor(diff / 3600) + 'h ago'
                return Math.floor(diff / 86400) + 'd ago'
            }

            function formatTime(dateStr) {
                if (!dateStr) return ''
                const d = new Date(dateStr)
                return d.toLocaleString('en-GB', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' })
            }

            // Watch tab changes to load data
            watch(activeTab, async (tab) => {
                if (tab === 'tasks') loadTasks()
                if (tab === 'traces') { loadTraces(); loadLocalTasks() }
                if (tab === 'config') loadConfig()
                if (tab === 'members') { loadMembers(); loadMembershipHistory() }
                if (tab === 'audit') loadAudit()
                if (tab === 'topics') {
                    await loadTopics()
                    await loadTopicFlow()
                    await loadTopicHealth()
                }
            })

            watch([taskFilter, taskStatusFilter], () => loadTasks())

            onMounted(async () => {
                await loadAll()
                await loadConfig()
                // Poll every 10s
                pollTimer = setInterval(async () => {
                    await loadStatus()
                    await loadMembers()
                    if (activeTab.value === 'tasks') await loadTasks()
                    if (activeTab.value === 'traces') { await loadTraces(); await loadLocalTasks() }
                }, 10000)
            })

            onUnmounted(() => {
                if (pollTimer) clearInterval(pollTimer)
            })

            return {
                tabs, activeTab,
                status, members, tasks, traces, config, groupActive,
                stats, previousMembers, membershipHistory,
                auditEntries, auditSourceFilter, auditAgentFilter, filteredAuditEntries,
                showJoinModal, joining, leaving, joinError, quickJoinName, toast,
                expandedTasks, expandedTraces,
                taskDescription, taskContent, submittingTask, taskFilter, taskStatusFilter,
                traceAgentFilter, traceAgents,
                localTasks, expandedLocalTrace, localTraceSpans, localTraceTask,
                localTracePolicy, localTraceLoading, expandLocalTrace, spanTypeColor, selectedLocalSpan,
                configForm, savingConfig, configSaved, configRequiresRejoin,
                joinForm,
                // Topics
                topicsData, skillTopicsData, topicFlow, topicHealth,
                xpLeaderboard, topicCategoryFilter, selectedTopic, topicMessages,
                filteredTopics,
                // Factory pipe viz
                factoryContentPipes, factoryInfraPipes, factoryStiltTop,
                factoryInfraLabelY, factoryGroundY, factorySvgHeight,
                factoryAgents, factorySelectedPipe, factoryPipePosition,
                densityData, envelopeTypes, densityLoading, densityColor,
                agentX, agentJunctions, onPipeClick,
                densitySparklinePath, densitySparklineArea, tagFontSize,
                joinGroup, quickJoin, leaveGroup, submitTask, saveConfig,
                rejoinGroup, loadAudit, loadTopics,
                ensureTopic, browseTopic,
                getCategoryColor, getRankColor, getRankBg, getXPPercent,
                fillDefault, toggleTaskExpand, toggleTraceExpand,
                parseCaps, parseChannels, relativeTime, formatTime, formatDuration,
                loadTraces,
            }
        }
    }).mount('#app')
    </script>
</body>
</html>
